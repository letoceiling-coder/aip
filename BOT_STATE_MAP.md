# Карта состояний Telegram-бота АИП

## 📊 Диаграмма состояний (State Machine)

```
┌─────────────────────────────────────────────────────────────────┐
│                      НАЧАЛО (/start)                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ CHECK_SUBSCRIBE │ ← Проверка подписки на канал
                    └────────┬────────┘
                             │
                ┌────────────┼────────────┐
                │                        │
          НЕТ подписки          ПОДПИСАН
                │                        │
                ▼                        ▼
    ┌───────────────────┐      ┌──────────────┐
    │ SHOW_SUBSCRIBE_   │      │  MAIN_MENU   │ ← Главное меню
    │     SCREEN        │      └──────┬───────┘
    └────────┬──────────┘             │
             │                        │
             │ "Я подписался"         ├─── "Полезные материалы" ──┐
             │                        │                            │
             └────────────────────────┘                            │
                             │                                     │
                             ├─── "Записаться" ────┐              │
                             │                     │              │
                             └─── "Отзыв" ──→ [Ссылка Яндекс Карт]│
                                                                   │
    ┌─────────────────────────────────────────────────────────────┘
    │
    ▼
┌──────────────────┐
│ MATERIALS_LIST   │ ← Список 8 категорий
└────────┬─────────┘
         │
         ├─── Выбор категории
         │
         ▼
┌────────────────────┐
│ MATERIAL_CATEGORY  │ ← Карточка категории
└────────┬───────────┘
         │
         ├─── "Скачать материалы" → [Отправка файла/ссылки]
         ├─── "Назад" → MATERIALS_LIST
         │
         └─────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                  ФОРМА КОНСУЛЬТАЦИИ                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  CONSULTATION_DESCRIPTION ← Описание услуги                 │
│         │                                                    │
│         ├─── "Записаться"                                   │
│         │                                                    │
│         ▼                                                    │
│  CONSULTATION_FORM_NAME ← Ввод имени                        │
│         │                                                    │
│         ├─── Ввод текста                                    │
│         │                                                    │
│         ▼                                                    │
│  CONSULTATION_FORM_PHONE ← Ввод телефона                    │
│         │                                                    │
│         ├─── Ввод текста                                    │
│         │                                                    │
│         ▼                                                    │
│  CONSULTATION_FORM_DESCRIPTION ← Ввод описания (опционально)│
│         │                                                    │
│         ├─── Ввод текста или "Пропустить"                   │
│         │                                                    │
│         ▼                                                    │
│  CONSULTATION_SUBMIT ← Отправка заявки                      │
│         │                                                    │
│         └─── Сохранение в БД → MAIN_MENU (с подтверждением)│
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Детальная карта переходов

### Стартовые состояния

| Состояние | Триггер | Действие | Следующее состояние |
|-----------|---------|----------|---------------------|
| IDLE | `/start` | Проверка подписки | CHECK_SUBSCRIPTION |

### Проверка подписки

| Состояние | Условие | Действие | Следующее состояние |
|-----------|---------|----------|---------------------|
| CHECK_SUBSCRIPTION | Подписка есть | Показать главное меню | MAIN_MENU |
| CHECK_SUBSCRIPTION | Подписки нет | Показать экран подписки | SHOW_SUBSCRIBE_SCREEN |

### Экран подписки

| Состояние | Триггер | Действие | Следующее состояние |
|-----------|---------|----------|---------------------|
| SHOW_SUBSCRIBE_SCREEN | "Я подписался" | Повторная проверка | CHECK_SUBSCRIPTION |
| SHOW_SUBSCRIBE_SCREEN | Любое другое сообщение | Игнорировать | SHOW_SUBSCRIBE_SCREEN |

### Главное меню

| Состояние | Callback Data | Действие | Следующее состояние |
|-----------|---------------|----------|---------------------|
| MAIN_MENU | `menu_materials` | Показать список материалов | MATERIALS_LIST |
| MAIN_MENU | `menu_consultation` | Показать описание услуги | CONSULTATION_DESCRIPTION |
| MAIN_MENU | `menu_review` | Открыть ссылку Яндекс Карт | MAIN_MENU (остается) |

### Материалы

| Состояние | Callback Data | Действие | Следующее состояние |
|-----------|---------------|----------|---------------------|
| MATERIALS_LIST | `material_category_{id}` | Показать карточку категории | MATERIAL_CATEGORY |
| MATERIALS_LIST | `back_main_menu` | Вернуться в главное меню | MAIN_MENU |
| MATERIAL_CATEGORY | `material_download_{id}` | Отправить файл/ссылку | MATERIAL_CATEGORY (остается) |
| MATERIAL_CATEGORY | `back_materials_list` | Вернуться к списку | MATERIALS_LIST |

### Форма консультации

| Состояние | Ввод пользователя | Действие | Следующее состояние |
|-----------|-------------------|----------|---------------------|
| CONSULTATION_DESCRIPTION | Callback: `consultation_start` | Запросить имя | CONSULTATION_FORM_NAME |
| CONSULTATION_DESCRIPTION | `back_main_menu` | Вернуться в меню | MAIN_MENU |
| CONSULTATION_FORM_NAME | Текст (имя) | Сохранить имя, запросить телефон | CONSULTATION_FORM_PHONE |
| CONSULTATION_FORM_PHONE | Текст (телефон) | Сохранить телефон, запросить описание | CONSULTATION_FORM_DESCRIPTION |
| CONSULTATION_FORM_DESCRIPTION | Текст (описание) | Сохранить описание, отправить форму | CONSULTATION_SUBMIT |
| CONSULTATION_FORM_DESCRIPTION | "Пропустить" | Пропустить описание, отправить форму | CONSULTATION_SUBMIT |
| CONSULTATION_SUBMIT | (автоматически) | Сохранить в БД, показать подтверждение | MAIN_MENU |

## 📋 Callback Data Format

### Формат

```
{action}_{params}
```

### Примеры

```
menu_materials                    → Показать материалы
menu_consultation                 → Показать форму консультации
menu_review                       → Открыть ссылку на отзывы
material_category_5               → Показать категорию с ID=5
material_download_12              → Скачать материал с ID=12
back_main_menu                    → Вернуться в главное меню
back_materials_list               → Вернуться к списку материалов
consultation_start                → Начать форму консультации
consultation_skip_description     → Пропустить описание в форме
```

## 🎯 Текстовые сообщения бота

### Приветственное сообщение (главное меню)

```
Добро пожаловать в Аудиторско-консалтинговую группу «АИП» —
одну из ведущих консалтинговых компаний России в области
аудиторских, налоговых и юридических услуг.

Уже более 25 лет мы помогаем бизнесу:
— выходить из сложных ситуаций
— выстраивать надёжную финансово-правовую систему
— заранее предотвращать риски

Выберите, чем можем быть полезны 👇
```

### Экран подписки

```
Для доступа к бета-версии необходимо подписаться на наш официальный Telegram-канал.
```

Кнопки:
- 🔔 Подписаться на Telegram (URL кнопка)
- ✅ Я подписался (callback_data: `check_subscription`)

### Описание услуги консультации

```
Если вашему бизнесу нужна профессиональная юридическая поддержка,
АИП возьмёт на себя все правовые вопросы.

Обращаясь к нам, вы сосредотачиваетесь на развитии бизнеса,
а не на юридических рисках.
```

Кнопки:
- 📝 Записаться на консультацию
- ⬅️ Назад в меню

### Категории материалов

Список (8 категорий):
1. Структурирование
2. Партнёрство
3. Проверки
4. Наследование
5. Ликвидация
6. Банкротство
7. Работа с задолженностями
8. Защита активов

Описание каждой категории:
```
{Название категории} —
{Описание из БД}

[Кнопки]
⬇️ Скачать материалы
⬅️ Назад
```

### Подтверждение заявки

```
Спасибо.
Мы свяжемся с вами в ближайшее время.
```

---

## 🔍 Примеры сценариев использования

### Сценарий 1: Новый пользователь

```
1. Пользователь: /start
   → Бот: Проверка подписки...
   → Результат: Не подписан
   → Бот: Показывает экран подписки

2. Пользователь: [Нажимает "Подписаться"]
   → Telegram: Открывает канал

3. Пользователь: [Нажимает "Я подписался"]
   → Бот: Повторная проверка...
   → Результат: Подписан
   → Бот: Показывает главное меню
```

### Сценарий 2: Запись на консультацию

```
1. Пользователь: [Главное меню] → "Записаться на консультацию"
   → Бот: Показывает описание услуги

2. Пользователь: [Нажимает "Записаться"]
   → Бот: "Введите ваше имя:"

3. Пользователь: "Иван Иванов"
   → Бот: Сохраняет имя, спрашивает: "Введите ваш телефон:"

4. Пользователь: "+79001234567"
   → Бот: Сохраняет телефон, спрашивает: "Краткое описание запроса (опционально, можете пропустить):"

5. Пользователь: "Нужна консультация по налогам"
   → Бот: Сохраняет описание, отправляет заявку
   → Бот: "Спасибо. Мы свяжемся с вами в ближайшее время."
   → Бот: Показывает главное меню
```

### Сценарий 3: Скачивание материала

```
1. Пользователь: [Главное меню] → "Полезные материалы"
   → Бот: Показывает список из 8 категорий

2. Пользователь: [Выбирает "Структурирование"]
   → Бот: Показывает описание категории

3. Пользователь: [Нажимает "Скачать материалы"]
   → Бот: Отправляет файл или ссылку
   → Бот: Инкрементирует счетчик скачиваний в БД
```

---

## 💡 Заметки по реализации

### Хранение состояния

Состояние пользователя хранится в `bot_users.current_state`.

Данные состояния (например, заполняемая форма) хранятся в `bot_users.state_data` (JSON):

```json
{
    "consultation": {
        "name": "Иван Иванов",
        "phone": "+79001234567",
        "description": "Нужна консультация"
    }
}
```

### Обработка неизвестных команд

Если пользователь в состоянии `MAIN_MENU` и отправляет текст (не callback), обрабатываем как команду или показываем подсказку:

```
"Не понимаю эту команду. Используйте кнопки меню для навигации."
```

### Обработка команды /start в любом состоянии

Команда `/start` всегда сбрасывает состояние и начинает заново:
1. Проверка подписки
2. Главное меню (если подписан)

---

**Дата создания**: 2025-01-15  
**Версия**: 1.0

