import{_ as I,c as i,a as e,b,t as c,F as q,q as D,w as N,d as f,v as w,N as J,r as m,m as z,k as O,o as d,p as C}from"./admin-CPkbdu2w.js";import{c as E,b as j,a as A,d as F}from"./api-BACpyIk9.js";import{S as g}from"./sweetalert2.esm.all-C0u8rGqG.js";const G={name:"Bots",setup(){const h=m(!1),o=m(!1),v=m(null),t=m([]),_=m(!1),x=m(!1),s=m(null),k=m(null),y=m(null),a=m({id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}),M=z({get:()=>{try{return JSON.stringify(a.value.settings||{},null,2)}catch{return"{}"}},set:r=>{try{a.value.settings=JSON.parse(r||"{}")}catch(l){console.error("Error parsing JSON:",l)}}}),p=async()=>{h.value=!0,v.value=null;try{const r=await E("/v1/bots");if(!r.ok){const n=await r.json().catch(()=>({}));throw new Error(n.message||"Ошибка загрузки ботов")}const l=await r.json();t.value=l.data||[]}catch(r){console.error("Error fetching bots:",r),v.value=r.message||"Ошибка загрузки ботов"}finally{h.value=!1}},W=r=>{try{const l=r.settings||{},n=l.webhook||{};a.value={id:r.id,name:r.name||"",token:r.token||"",welcome_message:r.welcome_message||"",is_active:r.is_active!==void 0?r.is_active:!0,settings:l,webhook_allowed_updates:Array.isArray(n.allowed_updates)?n.allowed_updates.join(", "):n.allowed_updates||"message, callback_query",webhook_max_connections:n.max_connections||40,webhook_secret_token:n.secret_token||""},x.value=!0}catch(l){console.error("Error editing bot:",l),g.fire({title:"Ошибка",text:"Не удалось загрузить данные бота",icon:"error",confirmButtonText:"ОК"})}},T=async r=>{if((await g.fire({title:"Удалить бота?",html:`Вы уверены, что хотите удалить бота <strong>"${r.name}"</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить",cancelButtonText:"Отмена",confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280"})).isConfirmed)try{const n=await F(`/v1/bots/${r.id}`);if(!n.ok){const u=await n.json().catch(()=>({}));throw new Error(u.message||"Ошибка удаления бота")}await g.fire({title:"Бот удален",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),await p()}catch(n){console.error("Error deleting bot:",n),g.fire({title:"Ошибка",text:n.message||"Ошибка удаления бота",icon:"error",confirmButtonText:"ОК"})}},U=async()=>{o.value=!0,v.value=null;try{const r={name:a.value.name,token:a.value.token,welcome_message:a.value.welcome_message||null,is_active:a.value.is_active},l=a.value.webhook_allowed_updates.split(",").map(u=>u.trim()).filter(u=>u);if(r.webhook={allowed_updates:l,max_connections:a.value.webhook_max_connections||40},a.value.webhook_secret_token&&(r.webhook.secret_token=a.value.webhook_secret_token),x.value){const u={...a.value.settings,webhook:r.webhook};r.settings=u}let n;if(x.value?n=await A(`/v1/bots/${a.value.id}`,r):n=await j("/v1/bots",r),!n.ok){const u=await n.json().catch(()=>({}));throw new Error(u.message||"Ошибка сохранения бота")}await g.fire({title:x.value?"Бот обновлен":"Бот создан",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),B(),await p()}catch(r){console.error("Error saving bot:",r),v.value=r.message||"Ошибка сохранения бота",g.fire({title:"Ошибка",text:r.message||"Ошибка сохранения бота",icon:"error",confirmButtonText:"ОК"})}finally{o.value=!1}},S=async r=>{s.value=r.id;try{const l=await E(`/v1/bots/${r.id}/check-webhook`);if(!l.ok){const u=await l.json().catch(()=>({}));throw new Error(u.message||"Ошибка проверки webhook")}const n=await l.json();y.value=n.data?.data||n.data||{}}catch(l){console.error("Error checking webhook:",l),g.fire({title:"Ошибка",text:l.message||"Ошибка проверки webhook",icon:"error",confirmButtonText:"ОК"})}finally{s.value=null}},V=async r=>{k.value=r.id;try{const l=await j(`/v1/bots/${r.id}/register-webhook`);if(!l.ok){const u=await l.json().catch(()=>({}));throw new Error(u.message||"Ошибка регистрации webhook")}const n=await l.json();await g.fire({title:n.success?"Webhook установлен":"Ошибка",text:n.message||(n.success?"Webhook успешно установлен":"Не удалось установить webhook"),icon:n.success?"success":"error",confirmButtonText:"ОК"}),await p()}catch(l){console.error("Error registering webhook:",l),g.fire({title:"Ошибка",text:l.message||"Ошибка регистрации webhook",icon:"error",confirmButtonText:"ОК"})}finally{k.value=null}},B=()=>{_.value=!1,x.value=!1,a.value={id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}};return O(()=>{p().catch(r=>{console.error("Error in onMounted:",r)})}),{loading:h,saving:o,error:v,bots:t,showCreateModal:_,showEditModal:x,form:a,settingsJson:M,checkingWebhook:s,registeringWebhook:k,webhookInfo:y,editBot:W,deleteBot:T,saveBot:U,checkWebhook:S,registerWebhook:V,closeModal:B}}},L={class:"bots-page space-y-6"},P={class:"flex items-center justify-between mb-6"},H={key:0,class:"flex items-center justify-center py-12"},R={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},K={class:"text-destructive"},Q={key:2,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},X={class:"flex items-start justify-between mb-4"},Y={class:"text-lg font-semibold text-foreground"},Z={key:0,class:"text-sm text-muted-foreground"},$={key:1,class:"text-sm text-muted-foreground"},ee={class:"space-y-2 mb-4"},oe={class:"flex items-center justify-between text-sm"},te=["title"],se={class:"flex flex-wrap gap-2"},re=["onClick","disabled"],ne=["onClick","disabled"],le=["onClick"],ae=["onClick"],ie={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},de={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ce={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"},ue={class:"sticky top-0 bg-background border-b border-border p-6"},be={class:"text-lg font-semibold"},me={class:"flex items-center gap-2 cursor-pointer"},ge={key:0,class:"space-y-4"},fe={class:"space-y-3"},xe={class:"flex gap-2 pt-4 border-t border-border"},ke=["disabled"],we={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ve={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md"},he={class:"p-6"},pe={class:"space-y-3"},_e={class:"text-sm text-foreground break-all"},ye={class:"text-sm text-foreground"},Be={key:0},Ce={class:"text-sm text-red-500"},Ee={key:1},je={class:"text-sm text-foreground"};function Me(h,o,v,t,_,x){return d(),i("div",L,[e("div",P,[o[13]||(o[13]=e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Боты"),e("p",{class:"text-muted-foreground mt-1"},"Управление Telegram ботами")],-1)),e("button",{onClick:o[0]||(o[0]=s=>t.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...o[12]||(o[12]=[e("span",null,"+",-1),e("span",null,"Добавить бота",-1)])])]),t.loading?(d(),i("div",H,[...o[14]||(o[14]=[e("p",{class:"text-muted-foreground"},"Загрузка ботов...",-1)])])):b("",!0),t.error?(d(),i("div",R,[e("p",K,c(t.error),1)])):b("",!0),!t.loading&&t.bots.length>0?(d(),i("div",Q,[(d(!0),i(q,null,D(t.bots,s=>(d(),i("div",{key:s.id,class:"bg-card rounded-lg border border-border p-6 hover:shadow-lg transition-shadow"},[e("div",X,[e("div",null,[e("h3",Y,c(s.name),1),s.username?(d(),i("p",Z,"@"+c(s.username),1)):(d(),i("p",$,"Username не указан"))]),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.is_active?"bg-green-500/10 text-green-500":"bg-gray-500/10 text-gray-500"])},c(s.is_active?"Активен":"Неактивен"),3)]),e("div",ee,[e("div",oe,[o[15]||(o[15]=e("span",{class:"text-muted-foreground"},"Webhook:",-1)),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.webhook_registered?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},c(s.webhook_registered?"Установлен":"Не установлен"),3)]),s.webhook_url?(d(),i("div",{key:0,class:"text-xs text-muted-foreground truncate",title:s.webhook_url},c(s.webhook_url),9,te)):b("",!0)]),e("div",se,[e("button",{onClick:k=>t.checkWebhook(s),disabled:t.checkingWebhook===s.id,class:"flex-1 px-3 py-2 text-xs bg-blue-500/10 hover:bg-blue-500/20 text-blue-500 rounded-lg transition-colors disabled:opacity-50"},c(t.checkingWebhook===s.id?"Проверка...":"Проверить webhook"),9,re),e("button",{onClick:k=>t.registerWebhook(s),disabled:t.registeringWebhook===s.id,class:"flex-1 px-3 py-2 text-xs bg-green-500/10 hover:bg-green-500/20 text-green-500 rounded-lg transition-colors disabled:opacity-50"},c(t.registeringWebhook===s.id?"Регистрация...":"Установить webhook"),9,ne),e("button",{onClick:k=>t.editBot(s),class:"px-3 py-2 text-xs bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 rounded-lg transition-colors"}," Редактировать ",8,le),e("button",{onClick:k=>t.deleteBot(s),class:"px-3 py-2 text-xs bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg transition-colors"}," Удалить ",8,ae)])]))),128))])):b("",!0),!t.loading&&t.bots.length===0?(d(),i("div",ie,[...o[16]||(o[16]=[e("p",{class:"text-muted-foreground"},"Боты не найдены. Добавьте первого бота.",-1)])])):b("",!0),t.showCreateModal||t.showEditModal?(d(),i("div",de,[e("div",ce,[e("div",ue,[e("h3",be,c(t.showEditModal?"Редактировать бота":"Добавить бота"),1)]),e("form",{onSubmit:o[10]||(o[10]=N((...s)=>t.saveBot&&t.saveBot(...s),["prevent"])),class:"p-6 space-y-4"},[e("div",null,[o[17]||(o[17]=e("label",{class:"text-sm font-medium mb-1 block"},"Название бота *",-1)),f(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>t.form.name=s),type:"text",required:"",placeholder:"Мой бот",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[w,t.form.name]])]),e("div",null,[o[18]||(o[18]=e("label",{class:"text-sm font-medium mb-1 block"},"Токен бота *",-1)),f(e("input",{"onUpdate:modelValue":o[2]||(o[2]=s=>t.form.token=s),type:"text",required:"",placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring font-mono text-sm"},null,512),[[w,t.form.token]]),o[19]||(o[19]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Получить токен можно у @BotFather",-1))]),e("div",null,[o[20]||(o[20]=e("label",{class:"text-sm font-medium mb-1 block"},"Приветственное сообщение",-1)),f(e("textarea",{"onUpdate:modelValue":o[3]||(o[3]=s=>t.form.welcome_message=s),rows:"4",placeholder:"Добро пожаловать! Это приветственное сообщение...",class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none"},null,512),[[w,t.form.welcome_message]])]),e("div",null,[o[22]||(o[22]=e("label",{class:"text-sm font-medium mb-1 block"},"Активен",-1)),e("label",me,[f(e("input",{"onUpdate:modelValue":o[4]||(o[4]=s=>t.form.is_active=s),type:"checkbox",class:"w-4 h-4"},null,512),[[J,t.form.is_active]]),o[21]||(o[21]=e("span",{class:"text-sm"},"Бот активен",-1))])]),t.showEditModal?(d(),i("div",ge,[e("div",null,[o[26]||(o[26]=e("label",{class:"text-sm font-medium mb-2 block"},"Настройки Webhook",-1)),e("div",fe,[e("div",null,[o[23]||(o[23]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Разрешенные обновления (через запятую)",-1)),f(e("input",{"onUpdate:modelValue":o[5]||(o[5]=s=>t.form.webhook_allowed_updates=s),type:"text",placeholder:"message, callback_query, inline_query",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_allowed_updates]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Максимальное количество соединений (1-100)",-1)),f(e("input",{"onUpdate:modelValue":o[6]||(o[6]=s=>t.form.webhook_max_connections=s),type:"number",min:"1",max:"100",placeholder:"40",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_max_connections,void 0,{number:!0}]])]),e("div",null,[o[25]||(o[25]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Secret Token (опционально)",-1)),f(e("input",{"onUpdate:modelValue":o[7]||(o[7]=s=>t.form.webhook_secret_token=s),type:"text",placeholder:"Секретный токен для проверки webhook",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm font-mono"},null,512),[[w,t.form.webhook_secret_token]])])])]),e("div",null,[o[27]||(o[27]=e("label",{class:"text-sm font-medium mb-1 block"},"Дополнительные настройки (JSON)",-1)),f(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=s=>t.settingsJson=s),rows:"6",placeholder:'{"key": "value"}',class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none font-mono text-sm"},null,512),[[w,t.settingsJson]]),o[28]||(o[28]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Дополнительные настройки бота в формате JSON",-1))])])):b("",!0),e("div",xe,[e("button",{type:"button",onClick:o[9]||(o[9]=(...s)=>t.closeModal&&t.closeModal(...s)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),e("button",{type:"submit",disabled:t.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},c(t.saving?"Сохранение...":"Сохранить"),9,ke)])],32)])])):b("",!0),t.webhookInfo?(d(),i("div",we,[e("div",ve,[e("div",he,[o[33]||(o[33]=e("h3",{class:"text-lg font-semibold mb-4"},"Информация о webhook",-1)),e("div",pe,[e("div",null,[o[29]||(o[29]=e("span",{class:"text-sm font-medium text-muted-foreground"},"URL:",-1)),e("p",_e,c(t.webhookInfo.url||"Не установлен"),1)]),e("div",null,[o[30]||(o[30]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Ожидающие обновления:",-1)),e("p",ye,c(t.webhookInfo.pending_update_count||0),1)]),t.webhookInfo.last_error_message?(d(),i("div",Be,[o[31]||(o[31]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Последняя ошибка:",-1)),e("p",Ce,c(t.webhookInfo.last_error_message),1)])):b("",!0),t.webhookInfo.max_connections?(d(),i("div",Ee,[o[32]||(o[32]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Макс. соединений:",-1)),e("p",je,c(t.webhookInfo.max_connections),1)])):b("",!0)]),e("button",{onClick:o[11]||(o[11]=s=>t.webhookInfo=null),class:"w-full mt-4 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors"}," Закрыть ")])])])):b("",!0)])}const Se=I(G,[["render",Me]]);export{Se as default};
